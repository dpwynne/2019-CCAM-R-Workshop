---
title: "Data Visualization"
subtitle: "with R and ggplot2"
author: "Dwight Wynne"
date: "November 14, 2019"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

# Why Visualize Data?

- Humans are visual animals!

--

- We have a mind for pictures, not so much for numbers

---
background-image: url(foxnews_piechart.png)

# Data Visualization is Hard!

.footnote[
https://flowingdata.com/2009/11/26/fox-news-makes-the-best-pie-chart-ever/
]

---
class: top, left

# Why Use R?

- "Excel still encourages people to produce bad graphs - in some respects more than in the past because it now offers even more dysfunctional choices."<sup>1</sup>


.footnote[
[1] Stephen Few, *Show Me the Numbers*
]

--

- R (with the ggplot2 package) gives you almost total control over every aspect of your graphs

--

- It's harder to do but easier to do *well*!


---

# Warm-Up Exercise

.pull-left[
![](option1.png)
![](option4.png)
]

.pull-right[
![](option2.png)
![](option3.png)
]
???

Four graphs showing the average home price in four ZIP codes in July-September 2019

1) Which of the four graphs is best for this purpose?
2) Is there a better way to display this information?
3) What information is NOT being shown here?

---
class: center, middle
# Overview

Tonight we will create the following graphs:

![](cereal_barplot.png)

---
class: center, middle
# Overview

Tonight we will create the following graphs:

![](housing_scatterplot.png)

---
class: center, middle
# Overview

Tonight we will create the following graphs:

![](crime_lineplot.png)


---

# Getting Started with R

- Open R Studio

- Open a new script: File $\rightarrow$ New File $\rightarrow$ R Script

--

- All of the work we do tonight will go in this script

---

# Getting Started with R

At the top of your script file, you want to load the R packages you are going to need:

```{r load ggplot2, warning=FALSE}
library(ggplot2) #<<
# Rest of code will go here
```


---

# Getting Started with R

Let's load the data first. We should see three datasets:

- cereal_calories
- housing
- lacrime2017

--

```{r load data, results = "hide", message = FALSE, warning = FALSE}
library(readr)
cereal <- read_csv("cereal_calories.csv")
housing <- read_csv("housing.csv")
crime <- read_csv("lacrime2017.csv")
```

- Click the `Import Dataset` button to import the data

- Select `From Text (readr)` if that option is available

- Find the file

- In the `Import Options` box, change the names as shown in the code above

---

# Graph Workflow with ggplot2

Start by setting up the graph:

```r 
* ggplot(data = dataset, 
*        mapping = aes(x = x-variable, y = y-variable))
```

--

Then indicate what type of graph to make, e.g.:

```r
* + geom_bar() # for a barplot
* + geom_line() # for a line graph
```

--

Then customize the graph, e.g.:

```r
* + labs() # add or change axis labels
* + theme() # customize elements of the plot
```
--

Save your graph after each step!

--

Once you're happy with your graph, `print` it

---

# Graph Workflow with ggplot2

When in doubt:

- What am I trying to customize?

- Search online for the function and argument that does it

- Add it to your workflow with `+`

---

# Bar Graphs

- Used to compare values between categories

- Most often, the number or proportion of observations in each category

- For BI purposes, often look at a summary value (such as average) in each category

---

# Bar Graphs

For counts, use `geom_bar()`:

```{r bargraph-setup, fig.show = "hide"}
zip_bargraph <- ggplot(data = housing, 
                       mapping = aes(x = as.factor(ZipCode))
                       ) + geom_bar() #<<
print(zip_bargraph)
```
```{r ref.label="bargraph-setup", echo = FALSE, fig.height=4}
```

---

# Bar Graphs

For numbers, use `geom_col()`:

```{r bargraph2-setup, fig.show = "hide"}
zip_bargraph2 <- ggplot(data = housing, 
                        mapping = aes(x = as.factor(ZipCode), y = Price)
                        ) + geom_col()  #<<
print(zip_bargraph2)
```

```{r ref.label="bargraph2-setup", echo = FALSE, fig.height=4}
```

---

# Example: Creating a Bar Graph

- Let's look at the average calories in cereal for each of the four companies in our dataset

- By default, if there are multiple values in the dataset, the graph will add them

- It's easiest to create a separate dataset that contains the averages:

--

```{r average cereal, message = FALSE, warning = FALSE}
library(dplyr)
cereal_averages <- cereal %>% 
  group_by(Manufacturer) %>%
  summarize(Calories = mean(Calories))
```

- If you can't run this code, import the cereal_averages.csv dataset

--

- If you want to know more about how this code works, come back December 5!

---

# Example: Creating a Bar Graph

Now let's set up our graph:

.pull-left[
```{r cereal-setup1, fig.show = "hide"}
cereal1 <- ggplot(cereal_averages, 
                  aes(x = Manufacturer, y = Calories)) + 
           geom_col()
print(cereal1)
```
]

.pull-right[
```{r ref.label="cereal-setup1", echo = FALSE}
```
]

---
# Example: Creating a Bar Graph

Let's fix a couple of things here.

First, let's change the code to add color.

.pull-left[
```{r cereal-setup2, fig.show = "hide"}
cereal1 <- ggplot(cereal_averages, 
                  aes(x = Manufacturer, y = Calories)) + 
geom_col(aes(fill = Manufacturer))  #<<
print(cereal1)
```

- Adding colors added a legend!

]

.pull-right[
```{r ref.label="cereal-setup2", echo = FALSE}
```
]

---
# Example: Creating a Bar Graph

Let's fix a couple of things here.

Next, let's reorder the bars.

.pull-left[
```{r cereal-setup3, fig.show = "hide"}
cereal1 <- ggplot(cereal_averages, 
                  aes(x = reorder(Manufacturer, -Calories), #<<
                      y = Calories)) + 
geom_col(aes(fill = Manufacturer))
print(cereal1)
```

- The `reorder` command changes the bar order

]

.pull-right[
```{r ref.label="cereal-setup3", echo = FALSE}
```
]

---

# Example: Creating a Bar Graph

Now let's customize our graph, starting with the axis labels.

We can just add customization to the already saved plot!

.pull-left[
```{r cereal-labels, fig.show = "hide"}
cereal2 <- cereal1 + 
  labs(x = "Company", y = "Calories") #<<
print(cereal2)
```

]


.pull-right[
```{r ref.label="cereal-labels", echo = FALSE}
```
]

---
# Example: Creating a Bar Graph

Now let's add our title:

.pull-left[
```{r cereal-title, fig.show = "hide"}
cereal3 <- cereal2 + 
  ggtitle("Average Calories by Cereal Manufacturer") #<<
print(cereal3)
```

]


.pull-right[
```{r ref.label="cereal-title", echo = FALSE}
```
]

---
# Example: Creating a Bar Graph

Now let's fix the colors. I like to use a color-blind palette<sup>1</sup>:

```{r colorblind}
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

.pull-left[
```{r cereal-color, fig.show = "hide"}
cereal4 <- cereal3 + 
  scale_fill_manual(values = cbPalette[c(8,4,6,7)]) #<<
print(cereal4)
```

]


.pull-right[
```{r ref.label="cereal-color", echo = FALSE}
```
]

.footnote[
[1] https://jfly.uni-koeln.de/color/
]

---
# Example: Creating a Bar Graph

Finally, we have some cleaning to do:

- Get rid of the legend

.pull-left[
```{r cereal-nolegend, fig.show = "hide"}
cereal5 <- cereal4 + 
  theme(legend.position = "none") #<<
print(cereal5)
```

]


.pull-right[
```{r ref.label="cereal-nolegend", echo = FALSE}
```
]


---
# Example: Creating a Bar Graph

Finally, we have some cleaning to do:

- Center the title

.pull-left[
```{r cereal-centered, fig.show = "hide"}
cereal6 <- cereal5 + 
  theme(plot.title = element_text(hjust = 0.5)) #<<
print(cereal6)
```

]

.pull-right[
```{r ref.label="cereal-centered", echo = FALSE}
```
]

---

# Reading a Bar Graph

- Compare the heights of the bars to compare the categories

- The bars in the bar graph *must* start at 0 for the heights of the bars to be comparable

![](cereal_barplot.png)

???

With `ggplot2` it's essentially impossible to create a misleading graph!

---

Scatterplots and line graphs section

---

What to look for in a scatterplot/line graph

- Trend direction and strength

- Outliers

---

Theme elements (theme_bw and theme_minimal)

---

Adding title and axis labels

---

Faceting: working by group

---

Adding Annotations

---

# Presenting with Graphs

Your audience typically has a limited idea of your data and why it's important. Walking an audience through a graph is an art form, but there is a structure to it.

I walk my audiences through graphs in this order:

1. Subject

1. Axes and color

1. Main points

1. Actionable takeaways

---

# Subject

- *Never* jump in immediately with the point you want to make!

- You need to quickly make sure everyone understands *what* you have graphed

- Even if it's just filler, your audience will appreciate the pause to take in the graph with their own eyes

Examples:

"This graph shows the relationship between employee age and health care costs."

"This graph shows our department's expenses over the past three years."

---

# Axes and Color

- Before you can tell the audience where to direct their attention, you have to tell them what they are attending to!

- Quickly explain what the x-axis and y-axis represent and include units

- These axes should be also labeled with variable names/descriptions (exception: blindingly obvious cases like dates, times, and locations)

- If color is important (not just cosmetic), mention what the color represents.

Examples:

"The x-axis represents employee age and the y-axis represents our health care expenditures for them in dollars."

"The x-axis shows the month and the y-axis shows the estimated expenses in thousands of dollars. The black line represents direct costs and the blue line represents indirect."

---

# Main Points

- Now that you have oriented your audience, you can easily bring their attention to the parts of the graph you want to highlight

- Communicate the same things that you looked for when you were creating the graph

- Often it helps to literally point these things out (using a finger or laser pointer)!

Examples:

"In general, as expected, health care costs rise with age, but we have a few outlier employees that are costing less than expected."

"The general trend is that indirect costs have skyrocketed while direct costs have barely increased."

---

# Actionable Takeaways

- This is not always your place!

- Especially as a BI professional or data scientist, your job is to break down complex information for decision makers who have a better big-picture view.

- If you are the decision maker, or asked for your opinion, you should use the insights from the graph to suggest possible actions

- This step often requires looking at other information beyond just what is in your graphs - it may be elsewhere in your data or external to it

Examples:

"Are these employees actually unusually healthy, or are they neglecting their health and likely to cost us more money in the long run? We should investigate."

"We anticipate that corporate will be giving us more projects to reduce our indirect cost rate."

---

Graph Example 1

---

Graph Example 2